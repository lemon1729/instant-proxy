worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    resolver 127.0.0.11 ipv6=off;

    # 1. UI용 메인 서버 (모든 루트 도메인 처리)
    # 예: example.com, test.com 접속 시 UI 표시
    server {
        listen 80;
        # 여러 도메인을 나열합니다 (docker-compose의 환경변수와 일치시켜주세요)
        server_name example.com test.com; 

        location / {
            proxy_pass http://web:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }

    # 2. 와일드카드 서브도메인 처리
    # 예: *.example.com, *.test.com 모두 여기로 들어옴
    server {
        listen 80;
        server_name *.example.com *.test.com;

        location / {
            set $target_backend "";

            access_by_lua_block {
                local redis = require "resty.redis"
                local red = redis:new()
                red:set_timeout(1000)

                local ok, err = red:connect("redis", 6379)
                if not ok then
                    ngx.log(ngx.ERR, "Redis 연결 실패: ", err)
                    return ngx.exit(500)
                end

                -- [핵심 변경] 전체 호스트네임을 키로 사용 (예: "sub.example.com")
                local host = ngx.var.host
                
                -- Redis 조회
                local res, err = red:get(host)

                if not res or res == ngx.null then
                    ngx.status = 404
                    ngx.say("<h1>404 Not Found</h1><p>연결된 정보가 없거나 만료되었습니다.</p>")
                    return ngx.exit(404)
                end

                ngx.var.target_backend = res
            }

            proxy_pass http://$target_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
